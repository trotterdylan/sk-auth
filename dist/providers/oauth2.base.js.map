{"version":3,"file":"oauth2.base.js","sources":["../../src/providers/oauth2.base.ts"],"sourcesContent":["import { Provider } from \"./base\";\nexport class OAuth2BaseProvider extends Provider {\n    async signin(request, auth) {\n        const { method, host, query } = request;\n        const state = [`redirect=${query.get(\"redirect\") ?? this.getUri(auth, \"/\", host)}`].join(\",\");\n        const base64State = Buffer.from(state).toString(\"base64\");\n        const nonce = Math.round(Math.random() * 1000).toString();\n        const url = await this.getAuthorizationUrl(request, auth, base64State, nonce);\n        if (method === \"POST\") {\n            return {\n                body: {\n                    redirect: url,\n                },\n            };\n        }\n        return {\n            status: 302,\n            headers: {\n                Location: url,\n            },\n        };\n    }\n    getStateValue(query, name) {\n        if (query.get(\"state\")) {\n            const state = Buffer.from(query.get(\"state\"), \"base64\").toString();\n            return state\n                .split(\",\")\n                .find((state) => state.startsWith(`${name}=`))\n                ?.replace(`${name}=`, \"\");\n        }\n    }\n    async callback({ query, host }, auth) {\n        const code = query.get(\"code\");\n        const redirect = this.getStateValue(query, \"redirect\");\n        const tokens = await this.getTokens(code, this.getCallbackUri(auth, host));\n        let user = await this.getUserProfile(tokens);\n        if (this.config.profile) {\n            user = await this.config.profile(user, tokens);\n        }\n        return [user, redirect ?? this.getUri(auth, \"/\", host)];\n    }\n}\n"],"names":["Provider"],"mappings":";;;;;;iCACwCA,wBAAS;AAAA,QACvC,OAAO,SAAS,MAAM;AACxB,UAAM,EAAE,QAAQ,MAAM,UAAU;AAChC,UAAM,QAAQ,CAAC,YAAY,MAAM,IAAI,eAAe,KAAK,OAAO,MAAM,KAAK,SAAS,KAAK;AACzF,UAAM,cAAc,OAAO,KAAK,OAAO,SAAS;AAChD,UAAM,QAAQ,KAAK,MAAM,KAAK,WAAW,KAAM;AAC/C,UAAM,MAAM,MAAM,KAAK,oBAAoB,SAAS,MAAM,aAAa;AACvE,QAAI,WAAW,QAAQ;AACnB,aAAO;AAAA,QACH,MAAM;AAAA,UACF,UAAU;AAAA;AAAA;AAAA;AAItB,WAAO;AAAA,MACH,QAAQ;AAAA,MACR,SAAS;AAAA,QACL,UAAU;AAAA;AAAA;AAAA;AAAA,EAItB,cAAc,OAAO,MAAM;AACvB,QAAI,MAAM,IAAI,UAAU;AACpB,YAAM,QAAQ,OAAO,KAAK,MAAM,IAAI,UAAU,UAAU;AACxD,aAAO,MACF,MAAM,KACN,KAAK,CAAC,WAAU,OAAM,WAAW,GAAG,WACnC,QAAQ,GAAG,SAAS;AAAA;AAAA;AAAA,QAG5B,SAAS,EAAE,OAAO,QAAQ,MAAM;AAClC,UAAM,OAAO,MAAM,IAAI;AACvB,UAAM,WAAW,KAAK,cAAc,OAAO;AAC3C,UAAM,SAAS,MAAM,KAAK,UAAU,MAAM,KAAK,eAAe,MAAM;AACpE,QAAI,OAAO,MAAM,KAAK,eAAe;AACrC,QAAI,KAAK,OAAO,SAAS;AACrB,aAAO,MAAM,KAAK,OAAO,QAAQ,MAAM;AAAA;AAE3C,WAAO,CAAC,MAAM,YAAY,KAAK,OAAO,MAAM,KAAK;AAAA;AAAA;;;;"}