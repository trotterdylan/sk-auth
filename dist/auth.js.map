{"version":3,"file":"auth.js","sources":["../src/auth.ts"],"sourcesContent":["import cookie from \"cookie\";\nimport * as jsonwebtoken from \"jsonwebtoken\";\nimport { join } from \"./path\";\nexport class Auth {\n    constructor(config) {\n        this.config = config;\n        this.get = async (request) => {\n            const { path } = request;\n            if (path === this.getPath(\"csrf\")) {\n                return { body: \"1234\" };\n            }\n            else if (path === this.getPath(\"session\")) {\n                const session = await this.getSession(request);\n                return {\n                    body: {\n                        session,\n                    },\n                };\n            }\n            return await this.handleEndpoint(request);\n        };\n        this.post = async (request) => {\n            return await this.handleEndpoint(request);\n        };\n        this.getSession = async ({ headers }) => {\n            const token = await this.getToken(headers);\n            if (token) {\n                if (this.config?.callbacks?.session) {\n                    return await this.config.callbacks.session(token, { user: token.user });\n                }\n                return { user: token.user };\n            }\n            return {};\n        };\n    }\n    get basePath() {\n        return this.config?.basePath ?? \"/api/auth\";\n    }\n    getJwtSecret() {\n        if (this.config?.jwtSecret) {\n            return this.config?.jwtSecret;\n        }\n        if (this.config?.providers?.length) {\n            const provs = this.config?.providers?.map((provider) => provider.id).join(\"+\");\n            return Buffer.from(provs).toString(\"base64\");\n        }\n        return \"svelte_auth_secret\";\n    }\n    async getToken(headers) {\n        if (!headers.cookie) {\n            return null;\n        }\n        const cookies = cookie.parse(headers.cookie);\n        if (!cookies.svelteauthjwt) {\n            return null;\n        }\n        let token;\n        try {\n            token = (jsonwebtoken.verify(cookies.svelteauthjwt, this.getJwtSecret()) || {});\n        }\n        catch {\n            return null;\n        }\n        if (this.config?.callbacks?.jwt) {\n            token = await this.config.callbacks.jwt(token);\n        }\n        return token;\n    }\n    getBaseUrl(host) {\n        return this.config?.host ?? `http://${host}`;\n    }\n    getPath(path) {\n        const pathname = join([this.basePath, path]);\n        return pathname;\n    }\n    getUrl(path, host) {\n        const pathname = this.getPath(path);\n        return new URL(pathname, this.getBaseUrl(host)).href;\n    }\n    setToken(headers, newToken) {\n        const originalToken = this.getToken(headers);\n        return {\n            ...(originalToken ?? {}),\n            ...newToken,\n        };\n    }\n    signToken(token) {\n        const opts = !token.exp\n            ? {\n                expiresIn: this.config?.jwtExpiresIn ?? \"30d\",\n            }\n            : {};\n        const jwt = jsonwebtoken.sign(token, this.getJwtSecret(), opts);\n        return jwt;\n    }\n    async getRedirectUrl(host, redirectUrl) {\n        let redirect = redirectUrl || this.getBaseUrl(host);\n        if (this.config?.callbacks?.redirect) {\n            redirect = await this.config.callbacks.redirect(redirect);\n        }\n        return redirect;\n    }\n    async handleProviderCallback(request, provider) {\n        const { headers, host } = request;\n        const [profile, redirectUrl] = await provider.callback(request, this);\n        let token = (await this.getToken(headers)) ?? { user: {} };\n        if (this.config?.callbacks?.jwt) {\n            token = await this.config.callbacks.jwt(token, profile);\n        }\n        else {\n            token = this.setToken(headers, { user: profile });\n        }\n        const jwt = this.signToken(token);\n        const redirect = await this.getRedirectUrl(host, redirectUrl ?? undefined);\n        return {\n            status: 302,\n            headers: {\n                \"set-cookie\": `svelteauthjwt=${jwt}; Path=/; HttpOnly`,\n                Location: redirect,\n            },\n        };\n    }\n    async handleEndpoint(request) {\n        const { path, headers, method, host } = request;\n        if (path === this.getPath(\"signout\")) {\n            const token = this.setToken(headers, {});\n            const jwt = this.signToken(token);\n            if (method === \"POST\") {\n                return {\n                    headers: {\n                        \"set-cookie\": `svelteauthjwt=${jwt}; Path=/; HttpOnly`,\n                    },\n                    body: {\n                        signout: true,\n                    },\n                };\n            }\n            const redirect = await this.getRedirectUrl(host);\n            return {\n                status: 302,\n                headers: {\n                    \"set-cookie\": `svelteauthjwt=${jwt}; Path=/; HttpOnly`,\n                    Location: redirect,\n                },\n            };\n        }\n        const regex = new RegExp(join([this.basePath, `(?<method>signin|callback)/(?<provider>\\\\w+)`]));\n        const match = path.match(regex);\n        if (match && match.groups) {\n            const provider = this.config?.providers?.find((provider) => provider.id === match.groups.provider);\n            if (provider) {\n                if (match.groups.method === \"signin\") {\n                    return await provider.signin(request, this);\n                }\n                else {\n                    return await this.handleProviderCallback(request, provider);\n                }\n            }\n        }\n        return {\n            status: 404,\n            body: \"Not found.\",\n        };\n    }\n}\n"],"names":["cookie","jsonwebtoken","path","join"],"mappings":"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"}